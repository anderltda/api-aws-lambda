AWSTemplateFormatVersion: '2010-09-09'
Description: Criando CI/CD da api-aws-lambda
Resources:

# Criando o recurso S3 bucket para CodeBuild
  BuildArtifactsBucket:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: Enabled  
        
# This resource allows to connect CodeBuild with Github using Personal Access Token.
  CodeBuildSourceCredential:
    Type: AWS::CodeBuild::SourceCredential
    Properties:
      AuthType: PERSONAL_ACCESS_TOKEN
      ServerType: GITHUB
      Token: '3bcebf9387fbeb086bb61aa121aa43a8d4bf8680'   

# Criando o recurso CodeBuild
  CodeBuildApiAWSLambda:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: S3
        Location: 
          Fn::GetAtt:
          - BuildArtifactsBucket
          - Arn
        Name: NO_ARTIFACTS
        Packaging: NONE
      BadgeEnabled: true
      Description: CodeBuild project for api-aws-lambda
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:1.0
        Type: LINUX_CONTAINER
      Name: code-build-api-aws-lambda
      ServiceRole:
        Fn::GetAtt:
        - CodeBuildRole
        - Arn    
      Source:
        Auth:
          Resource: !Ref CodeBuildSourceCredential
          Type: OAUTH
        GitCloneDepth: 1
        GitSubmodulesConfig:
          FetchSubmodules: true
        Location: https://github.com/anderltda/api-aws-lambda
        ReportBuildStatus: true
        Type: GITHUB
        
# Criando o recurso CodePipeline          
  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      ArtifactStore:
        Type: S3
        Location: !Ref BuildArtifactsBucket
      RestartExecutionOnUpdate: true
      RoleArn:
        Fn::GetAtt:
        - CodePipelineRole
        - Arn
      Stages:
      - Name: Source
        Actions:
        - Name: Source
          InputArtifacts: []
          ActionTypeId:
            Category: Source
            Owner: ThirdParty
            Version: 1
            Provider: GitHub
          OutputArtifacts:
          - Name: SourceCode
          Configuration:
            Owner: anderltda
            Repo: api-aws-lambda
            Branch: master
            PollForSourceChanges: true
            OAuthToken: '3bcebf9387fbeb086bb61aa121aa43a8d4bf8680'
          RunOrder: 1
      - Name: Build
        Actions:
        - Name: Build
          ActionTypeId:
            Category: Build
            Owner: AWS
            Provider: CodeBuild
            Version: '1'
          InputArtifacts:
          - Name: SourceCode
          Configuration:
            ProjectName: 
              Fn::GetAtt:
              - CodeBuildApiAWSLambda
              - Arn
          RunOrder: 1
          
# Criando o ROLE para o CodeBuild poder permissao          
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Principal:
            Service: codebuild.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AdministratorAccess
                
# Criando o ROLE para o CodePipeline poder permissao          
  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Principal:
            Service: codepipeline.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AdministratorAccess      